<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy External Report</title>
    <style>
        :root {
            --primary: #6d4aff;
            --primary-hover: #5835e5;
            --primary-rgb: 109, 74, 255;
            --surface: #ffffff;
            --background: #f4f4f8;
            --text: #1b1b2f;
            --text-secondary: #6b6b7b;
            --border: #e0e0e6;
            --input-bg: #f9f9fc;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        [data-theme="dark"] {
            --primary: #8b6dff;
            --primary-hover: #7a5ce5;
            --surface: #222238;
            --background: #161625;
            --text: #e6e6e6;
            --text-secondary: #a0a0b0;
            --border: #35354f;
            --input-bg: #2c2c44;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
            flex: 1;
            padding-bottom: 100px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        h1 svg { width: 28px; height: 28px; color: var(--primary); }

        .grid-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) { .grid-layout { grid-template-columns: 1fr; } }

        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .form-group { margin-bottom: 1rem; position: relative; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary); }
        
        input, select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-secondary:hover { border-color: var(--text-secondary); background: var(--input-bg); }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            max-height: 70vh;
            overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; background: var(--surface); }
        th { 
            background: var(--input-bg); 
            color: var(--text-secondary); 
            padding: 1rem; 
            text-align: left; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            position: sticky; 
            top: 0; 
            z-index: 10;
        }
        td { padding: 0.8rem 1rem; border-top: 1px solid var(--border); font-size: 0.95rem; }
        tr:hover td { background: var(--input-bg); }

        td[contenteditable="true"] {
            background: rgba(var(--primary-rgb), 0.05);
            cursor: text;
            transition: background 0.2s;
        }
        td[contenteditable="true"]:focus {
            background: var(--surface);
            box-shadow: inset 0 0 0 2px var(--primary);
            outline: none;
        }

        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 8px; }
        .tag-new { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .tag-ext { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        
        .action-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: 50%; }
        .action-btn:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        .autocomplete-items {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: var(--shadow);
            display: none;
        }
        .autocomplete-items.show { display: block; }
        .suggestion { padding: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .suggestion:hover, .suggestion.active { background: var(--input-bg); }
        .suggestion .unit { color: var(--text-secondary); font-size: 0.8em; }

        .dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.8); backdrop-filter: blur(12px);
            padding: 10px 25px; border-radius: 50px;
            display: flex; gap: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 100;
        }
        [data-theme="dark"] .dock { background: rgba(22, 22, 37, 0.8); border-color: rgba(255,255,255,0.1); }
        
        .dock-item { cursor: pointer; color: var(--text); transition: 0.2s; position: relative; display: flex; align-items: center; justify-content: center; }
        .dock-item:hover { color: var(--primary); transform: translateY(-3px); }
        .dock-item svg { width: 24px; height: 24px; }
        
        .dock-tooltip {
            position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%);
            background: var(--text); color: var(--background);
            padding: 4px 8px; border-radius: 4px; font-size: 12px;
            opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap;
        }
        .dock-item:hover .dock-tooltip { opacity: 1; bottom: 150%; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal { background: var(--surface); padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 500px; box-shadow: var(--shadow); }
        .modal h2 { margin-top: 0; color: var(--primary); }

        .switch { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .switch input { display: none; }
        .slider { width: 40px; height: 22px; background: var(--border); border-radius: 22px; position: relative; transition: 0.3s; }
        .slider:before { content: ""; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .report-header { display: none; text-align: right; direction: rtl; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .report-header p { margin: 5px 0; font-size: 14pt; color: #000; }
        
        @media print {
            .no-print, .dock, .form-card { display: none !important; }
            .grid-layout { display: block; }
            .card { box-shadow: none; border: none; padding: 0; }
            .table-wrapper { overflow: visible; max-height: none; border: none; }
            th { position: static; border-bottom: 2px solid #000; color: #000; }
            td { border-bottom: 1px solid #ddd; color: #000; }
            body { background: white; color: black; padding: 20px; }
            .report-header { display: block; }
        }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--success); color: white; padding: 12px 24px;
            border-radius: 50px; font-weight: 600; opacity: 0; transition: 0.3s;
            pointer-events: none; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #toast.show { opacity: 1; top: 40px; }
        #toast.error { background: var(--danger); }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="app-container">
        <header class="no-print">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                PharmaTrack
            </h1>
            <div style="display: flex; gap: 20px; align-items: center;">
                <label class="switch" title="Toggle Legacy Mode">
                    <span style="font-size: 0.9rem; font-weight: 600;">Legacy Mode</span>
                    <input type="checkbox" id="legacyToggle" onchange="toggleLegacyMode()">
                    <span class="slider"></span>
                </label>
                <div class="switch" onclick="toggleTheme()" title="Toggle Theme" style="background: var(--input-bg); padding: 5px; border-radius: 50%; width: 32px; height: 32px; justify-content: center;">
                    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                </div>
            </div>
        </header>

        <div class="report-header">
            <p>مرسل الي ادارة التموين الطبي والصيدليات</p>
            <p>فرع البحيرة المنطقة <span id="printRegion"></span></p>
            <p>صيدلية <span id="printPharmacy"></span></p>
            <p>بيان الخارجي عن شهر <span id="printMonth"></span></p>
        </div>

        <div class="grid-layout">
            <div class="form-card no-print">
                <div class="card">
                    <h3 style="margin-top:0; color: var(--primary);">Settings</h3>
                    
                    <div class="form-group">
                        <label>Region</label>
                        <select id="regionSelect" onchange="handleRegionChange()">
                            <option value="">Select Region</option>
                            <option value="first">الاولى</option>
                            <option value="second">الثانية</option>
                            <option value="third">الثالثة</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Pharmacy</label>
                        <select id="pharmacySelect" disabled onchange="handleContextChange()">
                            <option value="">Select Pharmacy</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Month</label>
                        <select id="monthSelect" onchange="handleContextChange()">
                            <option value="">Select Month</option>
                            <option value="January">يناير</option>
                            <option value="February">فبراير</option>
                            <option value="March">مارس</option>
                            <option value="April">ابريل</option>
                            <option value="May">مايو</option>
                            <option value="June">يونيو</option>
                            <option value="July">يوليو</option>
                            <option value="August">اغسطس</option>
                            <option value="September">سبتمبر</option>
                            <option value="October">اكتوبر</option>
                            <option value="November">نوفمبر</option>
                            <option value="December">ديسمبر</option>
                        </select>
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border); margin: 1.5rem 0;">

                    <div id="normalInputSection">
                        <h3 style="margin-top:0; font-size:1rem;">Add Entry</h3>
                        <div class="form-group">
                            <label>Product Search</label>
                            <input type="text" id="searchInput" placeholder="Search product..." autocomplete="off">
                            <div id="autocompleteList" class="autocomplete-items"></div>
                        </div>
                        <div class="form-group">
                            <label>Units Sold</label>
                            <input type="number" id="unitsInput" min="1" placeholder="0">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-primary" onclick="addEntryFromInput()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Add to List
                            </button>
                            <button class="btn btn-secondary" id="customBtn" disabled onclick="openCustomModal()">
                                Add Custom Product
                            </button>
                        </div>
                    </div>

                    <div id="legacyInputSection" style="display:none; text-align: center; color: var(--text-secondary); padding: 20px;">
                        <p><strong>Legacy Mode Active</strong></p>
                        <p style="font-size: 0.9em;">Edit the table directly.<br>Enter 0 to remove an item.</p>
                    </div>
                </div>
            </div>

            <div class="card" style="padding: 0; display: flex; flex-direction: column;">
                <div class="table-wrapper">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th width="120">Unit</th>
                                <th width="100">Sold</th>
                                <th width="60" class="no-print"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    <p>No items added yet.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="dock no-print">
        <div class="dock-item" onclick="downloadCSV()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
            <span class="dock-tooltip">Template</span>
        </div>
        <div class="dock-item" onclick="document.getElementById('fileInput').click()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
            <span class="dock-tooltip">Import</span>
            <input type="file" id="fileInput" hidden accept=".csv,.json" onchange="handleImport(this)">
        </div>
        <div class="dock-item" onclick="window.print()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
            <span class="dock-tooltip">Print</span>
        </div>
        <div class="dock-item" onclick="submitData()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span class="dock-tooltip">Submit</span>
        </div>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal">
            <h2>Add Custom Product</h2>
            <div class="form-group">
                <label>Reason / Category</label>
                <select id="customCategory">
                    <option value="">Select Reason</option>
                    <option value="قرار لجنة">قرار لجنة</option>
                    <option value="حكم قضائي">حكم قضائي</option>
                    <option value="داخل اللستة">داخل اللستة</option>
                    <option value="شئون طبية">شئون طبية</option>
                </select>
            </div>
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="customName">
            </div>
            <div class="form-group">
                <label>Unit</label>
                <input type="text" id="customUnit" placeholder="e.g. 10 T">
            </div>
            <div class="form-group">
                <label>Units Sold</label>
                <input type="number" id="customSold">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="addCustomProduct()">Add</button>
                <button class="btn btn-secondary" onclick="closeModal('customModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="bulkReasonModal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <h2>Missing Categories</h2>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Imported external items must have a category.</p>
            <div style="max-height: 300px; overflow-y: auto;">
                <table id="bulkReasonTable"></table>
            </div>
            <button class="btn btn-primary" onclick="saveBulkReasons()" style="margin-top: 15px;">Save & Continue</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCziPixswDPCbYf1zuxdR0A_Z4KgRSrc0I",
            authDomain: "plan-b-d4c36.firebaseapp.com",
            databaseURL: "https://plan-b-d4c36-default-rtdb.firebaseio.com",
            projectId: "plan-b-d4c36",
            storageBucket: "plan-b-d4c36.appspot.com",
            messagingSenderId: "647093759607",
            appId: "1:647093759607:web:e5086e95ec5b378ea4e072",
            measurementId: "G-S9S6T513SD"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const standardProducts = [
            "Antacid Syp|B", "Acetazolamide 250mg|10 T", "Acetylcysteine Sachets|10 Sach",
            "Acetylsalicylic Acid 75mg|10 T", "Acetylsalicylic Acid 81mg|10 T", "Acyclovir 0.05 cream|Tube",
            "Aescin gel|Tube", "Allopurinol 100mg|10 T", "Alpha Chymotrypsin|Amp", "Alpha Lipoic Acid 300mg|10 T",
            "Alpha Lipoic Acid 600mg|10 T", "Amantadine HCL 100mg|10 T", "Amaryl 2mg (حكم قضائي)|30 T",
            "Ambroxol|10 T", "Ambroxol Syp|B", "Amiodarone 200mg|10 T", "Amitriptyline 10mg|10 T",
            "Amitriptyline 25mg|10 T", "Amlodipine 10mg|10T", "Amlodipine 10mg & Valsartan 160mg|10 T",
            "Amlodipine 5mg|10 T", "Amlodipine 5mg & Olmesartan 20mg|10 T", "Amlodipine 5mg & Valsartan 160mg|10 T",
            "Amlodipine, Olmesartan & HCT 10/40/25mg|10 T", "Amlodipine, Olmesartan & HCT 5/20/12.5mg|10 T",
            "Amoxicillin & Clavulanic acid 1 gm|10 T", "Anagrelide 0.5mg|10 T", "Andovimpamide 100mg (استثناء من مدير الفرع)|10 T",
            "Antacid|10 T", "Antacid Syp|B", "Antibiotic & Corticosteroid cream|Tube", "Antifungal cream|Tube",
            "Anti-migraine|10 T", "Antirheumatic gel|Tube", "Apetryl 0.5mg ( الشئون الطبية)|10 T",
            "Apixaban 2.5mg|10 T", "Apixaban 5mg|10 T", "Aranesp 100mcg|Syringe", "Aripiprazole 30mg|10 T",
            "Artificial Tears|B", "Atorvastatin & Ezetimibe 20/10 mg|10 T", "Atorvastatin & Ezetimibe 40/10 mg|10 T",
            "Atorvastatin 20mg|10T", "Atorvastatin 40mg|10 T", "Atropine Sulphate ED|B",
            "Atropine Sulphate, Colchicine & Piperazine Sachets|12 Sach", "Avonex 30mcg (قرار لجنة)|Syringe",
            "Azathioprine 50 mg|10 T", "Beclomethasone & Salbutamol Inhalation|B", "Beclomethasone inhalation|B",
            "Bendamustin 100mg|vial", "Benztropine 2mg|10 T", "Betaferon (قرار لجنة)|Syringe", "Betahistine 8mg|10 T",
            "Betamethasone & Calcipotriol Cr.|Tube", "Betamethasone & Salicylic acid Lotion|B",
            "Betamethasone & Salicylic acid Oint.|Tube", "Betamethasone Cr.|Tube", "Betaxolol|B", "Bilichol|12 Cap",
            "Bional (قرار لجنة )|10 T", "Biperidene 2mg|10 T", "Bisoprolol 2.5mg|10 T", "Bisoprolol 5mg|10 T",
            "Bisoprolol 5mg & HCT 12.5mg|10 T", "Bleomycin 15 I.U|Vial", "Bosentan 62.5mg|10 T", "Brimonidine e.d|B",
            "Budesonide 160mcg & Formoterol 4.5mcg|B", "Bumetanide|10 T", "Cabergoline 0.5mg|2 T", "Caelyx|Vial",
            "Calcium 500mg|10 T", "Candesartan 16 mg|10 T", "Candesartan 16mg & HCT 12.5mg|10 T", "Candesartan 8mg|10 T",
            "Capecitabine 500mg|T", "Capoten 25mg (حكم قضائي)|10 T", "Captopril 50mg & HCT 25mg|10 T",
            "Carbamazepin 200mg|10 T", "Carbamazepin 400mg CR|10 T", "Carbamide cream|Tube", "Carbimazole 5mg|10 T",
            "Carboplatin 150mg|Vial", "Carboplatin 450mg|Vial", "Carfilzomib 60mg|Vial", "Carvedilol 12.5mg|10T",
            "Carvedilol 25mg|10 T", "Carvedilol 6.25mg|10 T", "Celecoxib 200mg|10 T", "Central Muscle Relaxant & Analgesic|10 T",
            "Cetirizine|10 T", "Cetuximab 100mg|Vial", "Chlorpromazine 100mg|10 T", "Cholecalciferol 10000IU|10 T",
            "Cholestyramine Sachets|12 Sach", "Chymotrypsin & Trypsin|10 T", "Cidophage 850mg (حكم قضائي)|10 T",
            "Cilostazole 100mg|10 T", "Cilostazole 50mg|10 T", "Cinacalcet 30mg|10 T", "Cinchocaine & Hydrocortisone cream|Tube",
            "Cinnarizine 25mg|10 T", "Cipralex 10mg (الشئون الطبية)|14 T", "Ciprapro (استثناء مدير الفرع)|10 T",
            "Ciprofloxacin 500mg|10 T", "Citalopram 20mg|7 T", "Citicoline 500mg|Amp", "Citicoline Syp|B",
            "Clobetasol Cream|Tube", "Clomipramine 25mg|10 T", "Clomipramine 75mg|10 T", "Clopidogrel 75mg|10 T",
            "Clotrimazole Cream|Tube", "Clotrimazole Soln.|B", "Clozapine 100mg|10 T", "Colchicine|10 T", "Cough Sedative|B",
            "Cyclosporin 50mg|5 T", "Cytarabine 1gm|Vial", "Dapagliflozin 10mg|10 T", "Dapagliflozin 5mg & Met. 1000mg|10 T",
            "Dapagliflozin 10mg & Met. 1000mg|10 T", "Darbepoetin Alpha (لجنه عليا)|Syringe", "Deferoxamine 500mg|Amp",
            "Dexamethasone , Neomycine & Polimyxin ED|B", "Dexamethasone , Neomycine & Polimyxin EO|Tube", "Diacerein 50mg|10 T",
            "Diclofenac gel|Tube", "Digestive|10 T", "Digoxine 0.25mg|10 T", "Diltiazem 60mg|10 T",
            "Diosmin 450mg & Hesperidin 50mg|10 T", "Domperidone 10mg|10 T", "Dorzolamide & Timolol ED|B",
            "Dostenix (حكم قضائي)|2 T", "Dothiepin 25mg|10 T", "Dothiepin 75mg|10 T", "Doxazosin 1mg|10 T",
            "Doxazosin 4mg|10 T", "Doxorubicin 20mg|Vial", "Doxycycline 100mg|10 Cap", "Duloxetine 30mg|10 T",
            "Empagliflozin 12.5mg & Met. 1000mg|10 T", "Empagliflozin 25mg|10 T", "Empagliflozin 25mg & Met. 1000mg|10 T",
            "Empagliflozin 5mg & Met. 1000mg|10 T", "Enalapril 20mg & HCT 12.5mg|10 T", "Endoxan 1g|Vial", "Endoxan 50mg|50T",
            "Enoxaparin 20mg|Syringe", "Enoxaparin 40mg|Syringe", "Enoxaparin 60mg|Syringe", "Enoxaparin 80mg|Syringe",
            "Entecavir 0.5mg|10 T", "Entecavir 1mg|10 T", "Erythropoietin alpha 4000IU|Vial", "Escitalopram 10mg|14T",
            "Esomeprazole 40 mg|10 Cap", "Estradiol Valerate & Norgestrel|21 T", "Ethamsylate 250 mg|10 T", "Etoposide 100mg|Amp",
            "Etoricoxib 120mg|10 T", "Etoricoxib 90mg|10 T", "Famotidine 20 mg|10 T", "Famotidine 40mg|10 T",
            "Febuxostat 40mg|10 T", "Febuxostat 80mg|10 T", "Fenofibrate 300mg|10 T", "Ferro Sanol Duodenal ( الشئون الطبية)|30 T",
            "Fexofenadine 120mg|10 T", "Fexofenadine 180mg|10 T", "Flavoxate 200mg|10 T", "Fluconazole 150mg|1 T",
            "Fluoxetine 20mg|10 T", "Fluticasone 125mcg & Salmeterol 25mcg|B", "Folic acid|10 T", "Formoterol|30 T",
            "Fucidic Acid Cream|Tube", "Furosemide 20mg & Spironolactone 50mg|10 T", "Gabapentin 100mg|10 T",
            "Gabapentin 400mg|10 T", "Galvus 50mg (حكم قضائي )|28 T", "Gastrobiotic 550mg (لجنه عليا)|10 T",
            "Gentamicin 80mg|Amp", "Gentamicin Cream|Tube", "Gilenya 0.5mg|28 Cap", "Ginkgo biloba|10 T",
            "Glibenclamide 5mg|10 T", "Glibenclamide 5mg & Met. 1000mg|10 T", "Glibenclamide 5mg & Met. 500mg|10 T",
            "Gliclazide 60mg|10 T", "Glimepiride 2mg|10 T", "Glimepiride 2mg & Met. 1000mg|10 T", "Glimepiride 3mg|10 T",
            "Glimepiride 4mg|10 T", "Glucosamine|10 T", "Gramicidin, Neomycin, Nystatin & Triamcinolone Cream|Tube",
            "Haloperidol 5mg|Amp", "Hexamine, Khellin & Piperazin Sachets|12 Sach", "Human chorionic gonadotropin|Amp",
            "Hydroxychloroquine|10 T", "Hydroxyurea|10 T", "Imipramine 25mg|10 T", "Indepamid 2.5 mg|10 T",
            "Indomethacin 100mg Supp.|10 Supp", "Insulin Isophane Protamine|Vial", "Insulin Isophane Protamine|Penfill",
            "Insulin Mix 70/30 (Insulin Isophane Protamine & Insulin Neutral Human)|Vial",
            "Insulin Mix 70/30 (Insulin Isophane Protamine & Insulin Neutral Human)|Penfill", "Insulin Neutral Human|Vial",
            "Insulin Neutral Human|Penfill", "Invega 100mg (قرار لجنة)|Syringe", "Invega 150mg (قرار لجنة)|Syringe",
            "Ipratropium & Salbutamol|Amp", "Irinotecan 100mg|Vial", "Iron|10 T", "Iruxol|Tube", "Isosorbide Mononitrate 20mg|10 T",
            "Ivabradine 5mg|10 T", "Ivabradine 7.5mg|10 T", "Ketosteril|100 T", "Ketotifen|10 T", "Lacosamide 100 mg|10 T",
            "Lactulose Syp|B", "Lamivudine|10 T", "Lamotrigine 100mg|10 T", "Latanoprost ED|B", "Laxative|10 T",
            "L-Carnitine Amp|Amp", "L-Carnitine Cap|10 Cap", "Leflunomide 20mg|10 T", "Lercanidipine 10mg|10 T",
            "Leucovorin Calcium 50mg|Amp", "Levetiracetam 1000mg|10 T", "Levetiracetam 500mg|10 T",
            "Levodopa & Carbidopa 250/25mg|10 T", "Levodopa, Carbidopa & Entacapone 150/37.5/200mg|10 T",
            "Levofloxacin 500mg|10 T", "Levothyroxine 100mcg|100 T", "Levothyroxine 25mcg|50 T", "Levothyroxine 50mcg|100 T",
            "Lidocaine cream|Tube", "Linezolid 600 mg|10 T", "Lithium Carbonate 400mg|10 T", "Lolawest (قرار لجنة )|6 Sach",
            "Long Acting Penicillin|Vial", "Losartan 50mg|10 T", "Losartan 50mg & HCT 12.5mg|10 T",
            "Magnesium Citrate Eff.|12 Sach", "Mayzent 0.25 mg (لجنة)|12 T", "Mebeverine 100mg & Sulpiride 25mg|10 T",
            "Meclofenoxate 500mg|10 T", "Memantine 10 mg|10 T", "Mesalazine 500mg|10 T", "Mesalazine Supp|28 Supp",
            "Metformin 500mg|10 T", "Metformin 850mg|10 T", "Methotrexate|Vial", "Methotrexate 2.5mg|10 T",
            "Methyl Folate (لجنة دواء)|10 T", "Methyldopa 250mg|10 T", "Metoclopramide 10mg|10 T", "Metoprolol 100mg|10 T",
            "Metoprolol 50mg|10 T", "Metronidazole 250mg|10 T", "Miconazole vaginal cream|Tube", "Minirin 60mcg (قرار لجنة)|30T",
            "Mometasone Cream|Tube", "Montelukast 10mg|10 T", "Mouth Wash|B", "Multivitamins|10 Cap", "Mycophenolate 180mg|10 T",
            "Mycophenolate 500mg|10 T", "Naftidrofuryl 200mg|10 T", "Naphazoline HCL 0.5mg & Chlorpheniramine maleate ED|B",
            "Napizole 20mg (حكم قضائي )|14 T", "Navelbin 20mg|T", "Nebivolol 2.5mg|10 T", "Nebivolol 5mg|10 T",
            "Nebivolol 5mg & HCT 12.5mg|10 T", "Nebivolol 5mg & HCT 25mg|10 T", "Neostigmine 15mg|10 T", "Nicorandil 10mg|10 T",
            "Nicorandil 20mg|10 T", "Nifedipine|10 T", "Nitroglycerin 2.5mg|10 Cap", "Nitroglycerin 5mg Patches|Patch",
            "Nitromak 2.5mg (حكم قضائي)|10 T", "Norethisterone|10 T", "N-plate|Syringe", "Ofev (حكم قضائي)|60 T",
            "Olanzapine 10mg|10 T", "Olmesartan 20mg|10 T", "Olmesartan 20mg & HCT 12.5mg|10 T", "Olmesartan 40mg|10 T",
            "Omega 3|10 T", "Omeprazole 20mg|7 T", "Omeprazole 40mg|10 T", "Opsumit 10mg|30 T", "Oxcarbazepine 300mg|10 T",
            "Oxybutynin 5mg|10 T", "Panthenol cream|Tube", "Pantoprazole 20mg|10 T", "Pantoprazole 40mg|10 T",
            "Paracetamol 500mg|10 T", "Pentasa (لجنة عليا)|10 T", "Pentasa Supp (لجنة عليا)|28 Supp",
            "Pentoxifylline 400mg|10 T", "Phenytoin 100mg|10 T", "Phenytoin 50mg|10 T", "Pimozide 4mg|10 T",
            "Piperazine, Hexamine & Khellin Eff.|12 Sach", "Piracetam 400mg|10 T", "Piracetam 800mg|10 T", "Piracetam Syp|B",
            "Pirfenex (حكم قضائي)|30 T", "Pirfenidone 200mg (قرار لجنة )|30 T", "Piroxicam 10mg|10 T", "Piroxicam 20mg|10 T",
            "Plendil 5mg (موافقة الشئون الطبية)|30 T", "Potassium|B", "Povidone Iodine Shampoo|B", "Pramipexol 0.25mg|10 T",
            "Pramipexol 1 mg|10 T", "Prednisolone 20mg|10 T", "Prednisolone 5mg|10 T", "Prednisolone ED|B",
            "Progesteron 100mg|10 Cap", "Progesteron 250mg|Amp", "Propafenone 150mg|10 T", "Propranolol 10mg|10 T",
            "Propranolol 40mg|10 T", "Propolis, Chamomile, Zinc Oxide & Honey Cream|Tube", "Propylthiouracil 50mg|10 T",
            "Pyridostigmine 60mg|10 T", "Quetiapine 100mg|10 T", "Quinidine sulphate 250mg|10T", "Ramipril 10mg|10 T",
            "Ramipril 2.5 mg|10 T", "Ramipril 5mg|10T", "Rasagiline 1mg|10 T", "Rebamipide|10 T", "Rebif 44mcg (قرار لجنة)|Syringe",
            "Rilutek (لجنة دواء)|56 T", "Riluzole 50mg|56 T", "Risperidone 1 mg|10 T", "Risperidone 2 mg|10 T",
            "Risperidone 3 mg|10 T", "Rivaroxaban 10mg|10 T", "Rivaroxaban 15mg|10 T", "Rivaroxaban 20mg|10 T",
            "Rivaroxban 2.5mg|10 T", "Rosuvastatin 20mg|10 T", "Rutin & Vit.C|10 T", "Salbutamol|10 T", "Salbutamol Inhaler|B",
            "Salbutamol Syp|B", "Sandostatin LAR|Syringe", "Sertraline 50 mg|10 T", "Sildenafil 20mg|10 T",
            "Sildenafil 50mg|10 T", "Sitagliptin 100mg|10 T", "Sitagliptin 50 mg & Met. 1000 mg|10 T", "Sodium Valproate 200mg|10 T",
            "Sodium Valproate 500mg|10 T", "Spiramycin 3MIU Tab|10 T", "Spironolactone 100 mg|10 T", "Spironolactone 25mg|10 T",
            "Stivarga 40mg|84T", "Sulphamethoxazole & Trimethoprim|10 T", "Sulphasalazine|10 T", "Tacrolimus 1mg|10 T",
            "Tamoxifen 10mg|10 T", "Tamsulosin 0.4mg|14T", "Tenofenamide 25mg|10 T", "Tenofovir 300mg|30 T",
            "Terbinafine 0.01 Cream|Tube", "Terbutaline|10 T", "Testosterone|Amp", "Tetracosactrin|Amp", "Theophylline 300mg|10 T",
            "Thrombonorm 0.5mg (لجنة عليا)|100 Cap", "Tiratam 1000 mg (تم الصرف بالاسم التجاري وفقا لتأشيرة الشئون الطبية)|10 T",
            "Tiratam 500mg (استثناء من مدير الفرع)|10 T", "Topiramate 100 mg|10 T", "Topiramate 25 mg|10 T", "Torsemide 20mg|10 T",
            "Tranexamic acid 500mg|10 T", "Travoprost ED|B", "Triamcinilone 40mg|Amp", "Trifluperazine 5mg (Stellasil)|10 T",
            "Trimebutine 200mg|10 T", "Trimetazidine 20mg|10 T", "Urinex|12 Cap", "Ursodeoxycholic acid 250mg|10 Cap",
            "Valcyte 450mg|60 T", "Valsartan 160mg|10T", "Valsartan 160mg & HCT 25mg|10 T", "Valsartan 40 mg|10 T",
            "Vastarel MR ( حكم قضائي )|30 T", "Verapamil 240mg|10 T", "Verapamil 80mg|10 T", "Vidaza 100mg|Vial",
            "Vildagliptin 50mg|10 T", "Vildagliptin 50mg & Metformin 1000mg|10 T", "Vildagliptin 50mg & Metformin 850mg|10 T",
            "Vildagluse plus 50/1000mg (حكم قضائي )|30 T", "Vinblastin 10mg|vial", "Vincamine 30mg|10 T", "Vincristine 1mg|Vial",
            "Vinorelbine 50mg|Vial", "Vitamin A|10 T", "Vitamin B amp|Amp", "Vitamin B comp|10 T", "Vitamin E 400|12 Cap",
            "Vitamin K|10 T", "Voriconazole 50mg|10 T", "Warfarin 1mg|10 T", "Warfarin 3mg|10 T", "Warfarin 5 mg|10 T",
            "Xarelto 20mg|28 T", "Xgeva|Vial", "Zoledronic 4mg|Vial"
        ].sort();

        const regionOptions = {
            first: ["كفر الدوار سكر", "كفر الدوار الشاملة 1" , "كفر الدوار الشاملة 2", "كفر الدوار مسائي", "النوبارية", "البيضا", "ابو المطامير", "رشيد", "ادكو"],
            second: ["دمنهور الشاملة 1", "دمنهور الشاملة 2", "دمنهور مسائي", "دمنهور سكر", "دمنهور اورام", "الشرطة", "حوش عيسي", "المحمودية مسائي", "المحمودية", "الرحمانية", "ابو حمص"],
            third: ["ايتاي الشاملة 1", "ايتاي الشاملة 2 ",   "ايتاي مسائي ","كوم حمادة", "كوم حمادة مسائي", "بدر","شبراخيت مسائي", "شبراخيت","الدلنجات مسائي", "الدلنجات", "وادي النطرون", "قليشان"]
        };

        const regionMap = { "first": "الاولى", "second": "الثانية", "third": "الثالثة" };
        const monthMap = { "January": "يناير", "February": "فبراير", "March": "مارس", "April": "ابريل", "May": "مايو", "June": "يونيو", "July": "يوليو", "August": "اغسطس", "September": "سبتمبر", "October": "اكتوبر", "November": "نوفمبر", "December": "ديسمبر" };

        let addedData = []; 
        let isLegacyMode = false;

        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');

            const savedData = localStorage.getItem('pharmacyData');
            if (savedData) addedData = JSON.parse(savedData);

            ['region', 'pharmacy', 'month'].forEach(key => {
                const val = localStorage.getItem('sel_' + key);
                if(val) document.getElementById(key + 'Select').value = val;
            });

            handleRegionChange(true); 
            renderTable();
            checkContext();
        });


        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
        }

        function toggleLegacyMode() {
            isLegacyMode = document.getElementById('legacyToggle').checked;
            document.getElementById('normalInputSection').style.display = isLegacyMode ? 'none' : 'block';
            document.getElementById('legacyInputSection').style.display = isLegacyMode ? 'block' : 'none';
            renderTable();
        }

        function handleRegionChange(skipSave = false) {
            const r = document.getElementById('regionSelect').value;
            const pSel = document.getElementById('pharmacySelect');
            const savedP = pSel.value;

            pSel.innerHTML = '<option value="">Select Pharmacy</option>';
            if(regionOptions[r]) {
                regionOptions[r].forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.textContent = p;
                    pSel.appendChild(opt);
                });
                pSel.disabled = false;
                if(regionOptions[r].includes(savedP)) pSel.value = savedP;
            } else {
                pSel.disabled = true;
            }

            if(!skipSave) handleContextChange();
        }

        function handleContextChange() {
            const r = document.getElementById('regionSelect').value;
            const p = document.getElementById('pharmacySelect').value;
            const m = document.getElementById('monthSelect').value;
            
            localStorage.setItem('sel_region', r);
            localStorage.setItem('sel_pharmacy', p);
            localStorage.setItem('sel_month', m);

            document.getElementById('printRegion').textContent = regionMap[r] || "";
            document.getElementById('printPharmacy').textContent = p || "";
            document.getElementById('printMonth').textContent = monthMap[m] || "";

            checkContext();
        }

        function checkContext() {
            const valid = document.getElementById('regionSelect').value && 
                          document.getElementById('pharmacySelect').value && 
                          document.getElementById('monthSelect').value;
            
            document.getElementById('customBtn').disabled = !valid;
            return valid;
        }

        function saveData() {
            localStorage.setItem('pharmacyData', JSON.stringify(addedData));
        }

        function updateData(name, unit, sold, method, category = null) {
            const idx = addedData.findIndex(d => d.name === name && d.unit === unit);
            
            if (sold <= 0) {
                if(idx > -1) addedData.splice(idx, 1);
            } else {
                if(idx > -1) {
                    addedData[idx].sold = sold;
                    if(category) addedData[idx].category = category;
                } else {
                    addedData.push({ name, unit, sold, method, category });
                }
            }
            saveData();
            renderTable();
        }


        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            let listToRender = [];

            if (isLegacyMode) {
                const dataMap = new Map(addedData.map(d => [`${d.name}|${d.unit}`, d]));
                
                standardProducts.forEach(prod => {
                    const [n, u] = prod.split('|');
                    const existing = dataMap.get(prod);
                    listToRender.push({
                        name: n, unit: u,
                        sold: existing ? existing.sold : '',
                        isCustom: false
                    });
                    if(existing) dataMap.delete(prod); 
                });

                dataMap.forEach(d => {
                    listToRender.push({
                        name: d.name, unit: d.unit, sold: d.sold, isCustom: true, category: d.category
                    });
                });

            } else {
                listToRender = addedData.map(d => ({
                    name: d.name, unit: d.unit, sold: d.sold, 
                    isCustom: d.method === 'new', category: d.category
                })).sort((a,b) => a.name.localeCompare(b.name));
            }

            if(listToRender.length === 0 && !isLegacyMode) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('dataTable').style.display = 'none';
                return;
            } else {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
            }

            listToRender.forEach(row => {
                const tr = document.createElement('tr');
                let nameHTML = `<strong>${row.name}</strong>`;
                if(row.isCustom) nameHTML += ` <span class="tag tag-new">New</span>`;
                if(row.category) nameHTML += ` <span class="tag tag-ext">${row.category}</span>`;

                const isEditable = isLegacyMode || !isLegacyMode; 

                tr.innerHTML = `
                    <td>${nameHTML}</td>
                    <td><span style="color:var(--text-secondary); font-size:0.9em">${row.unit}</span></td>
                    <td contenteditable="true" inputmode="numeric" 
                        onblur="handleInlineEdit(this, '${row.name}', '${row.unit}', ${row.isCustom})"
                        onkeydown="handleEnter(event, this)">${row.sold}</td>
                    <td class="no-print">
                        ${!isLegacyMode ? `<button class="action-btn" onclick="removeItem('${row.name}', '${row.unit}')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function handleInlineEdit(el, name, unit, isCustom) {
            const val = parseInt(el.textContent.replace(/[^0-9]/g, ''));
            if(isNaN(val)) {
                const exists = addedData.find(d => d.name === name && d.unit === unit);
                el.textContent = exists ? exists.sold : '';
                return;
            }
            updateData(name, unit, val, isCustom ? 'new' : 'old');
        }

        function handleEnter(e, el) {
            if(e.key === 'Enter') {
                e.preventDefault();
                el.blur();
                const nextRow = el.closest('tr').nextElementSibling;
                if(nextRow) {
                    const nextCell = nextRow.querySelector('[contenteditable]');
                    if(nextCell) nextCell.focus();
                }
            }
        }

        function removeItem(name, unit) {
            updateData(name, unit, 0, 'old');
        }


        const searchInput = document.getElementById('searchInput');
        const autoList = document.getElementById('autocompleteList');

        searchInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            autoList.innerHTML = '';
            if(!val) { autoList.classList.remove('show'); return; }

            const matches = standardProducts.filter(p => p.toLowerCase().includes(val));
            
            matches.forEach(m => {
                const [n, u] = m.split('|');
                const div = document.createElement('div');
                div.className = 'suggestion';
                div.innerHTML = `<span>${n}</span> <span class="unit">${u}</span>`;
                div.onclick = () => {
                    searchInput.value = m; 
                    searchInput.setAttribute('data-sel-name', n);
                    searchInput.setAttribute('data-sel-unit', u);
                    searchInput.value = n; 
                    autoList.classList.remove('show');
                    document.getElementById('unitsInput').focus();
                };
                autoList.appendChild(div);
            });
            
            if(matches.length) autoList.classList.add('show');
            else autoList.classList.remove('show');
        });

        document.addEventListener('click', (e) => {
            if(e.target !== searchInput) autoList.classList.remove('show');
        });

        function addEntryFromInput() {
            if(!checkContext()) { showToast('Select Region, Pharmacy & Month first', true); return; }

            const n = searchInput.getAttribute('data-sel-name');
            const u = searchInput.getAttribute('data-sel-unit');
            const val = parseInt(document.getElementById('unitsInput').value);

            if(!n || !u) {
                 showToast("Please select a product from the list or use Custom.", true);
                 return;
            }

            if(!val || val <= 0) { showToast("Enter valid quantity", true); return; }

            updateData(n, u, val, 'old');
            searchInput.value = '';
            searchInput.removeAttribute('data-sel-name');
            searchInput.removeAttribute('data-sel-unit');
            document.getElementById('unitsInput').value = '';
            searchInput.focus();
        }

        function openCustomModal() { document.getElementById('customModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function addCustomProduct() {
            const cat = document.getElementById('customCategory').value;
            const name = document.getElementById('customName').value;
            const unit = document.getElementById('customUnit').value;
            const sold = parseInt(document.getElementById('customSold').value);

            if(!cat || !name || !unit || !sold) { showToast("Fill all fields", true); return; }

            updateData(name, unit, sold, 'new', cat);
            closeModal('customModal');
            
            document.getElementById('customName').value = '';
            document.getElementById('customUnit').value = '';
            document.getElementById('customSold').value = '';
        }


        function downloadCSV() {
            const r = document.getElementById('regionSelect').value || 'Region';
            const p = document.getElementById('pharmacySelect').value || 'Pharmacy';
            const m = document.getElementById('monthSelect').value || 'Month';
            
            let csv = "month,region,pharmacy,name,unit,unitSold\n";
            const source = addedData.length ? addedData : standardProducts.slice(0,1).map(x => {
                const [n,u] = x.split('|'); return {name: n, unit: u, sold: 10}; 
            });

            source.forEach(d => {
                csv += `${m},${r},"${p}","${d.name}","${d.unit}",${d.sold}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'pharmacy_data.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function handleImport(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const txt = e.target.result;
                let count = 0;
                
                try {
                    const lines = txt.split('\n');
                    lines.forEach((l, i) => {
                        if(i===0 || !l.trim()) return;
                        const matches = l.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        if(matches && matches.length >= 6) {
                            const cols = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                            const name = cols[3];
                            const unit = cols[4];
                            const sold = parseInt(cols[5]);
                            
                            if(name && !isNaN(sold)) {
                                const full = `${name}|${unit}`;
                                const isStd = standardProducts.includes(full);
                                updateData(name, unit, sold, isStd ? 'old' : 'new');
                                count++;
                            }
                        }
                    });
                    showToast(`Imported ${count} items`);
                    checkMissingReasons();
                } catch(err) {
                    showToast("Error parsing file", true);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function checkMissingReasons() {
            const missing = addedData.filter(d => d.method === 'new' && !d.category);
            if(missing.length) {
                const tbl = document.getElementById('bulkReasonTable');
                tbl.innerHTML = missing.map((d, i) => `
                    <tr>
                        <td style="padding:10px; border-bottom:1px solid #eee;">${d.name} <small style="color:#888">${d.unit}</small></td>
                        <td style="padding:10px; border-bottom:1px solid #eee;">
                            <select id="reason_${i}" class="bulk-select" style="width:100%">
                                <option value="">Select Reason</option>
                                <option value="قرار لجنة">قرار لجنة</option>
                                <option value="حكم قضائي">حكم قضائي</option>
                                <option value="داخل اللستة">داخل اللستة</option>
                                <option value="شئون طبية">شئون طبية</option>
                            </select>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('bulkReasonModal').style.display = 'flex';
            }
        }

        function saveBulkReasons() {
            const missing = addedData.filter(d => d.method === 'new' && !d.category);
            let allSet = true;
            
            missing.forEach((d, i) => {
                const val = document.getElementById(`reason_${i}`).value;
                if(!val) allSet = false;
                else d.category = val;
            });

            if(!allSet) { alert("Please select reasons for all items"); return; }
            
            saveData();
            renderTable();
            closeModal('bulkReasonModal');
        }

        function submitData() {
            if(!checkContext()) { showToast("Missing details", true); return; }
            if(addedData.length === 0) { showToast("List is empty", true); return; }
            
            const missing = addedData.filter(d => d.method === 'new' && !d.category);
            if(missing.length) { checkMissingReasons(); return; }

            const r = document.getElementById('regionSelect').value;
            const p = document.getElementById('pharmacySelect').value;
            const m = document.getElementById('monthSelect').value;

            const payload = addedData.map(d => ({
                month: m, region: r, pharmacy: p,
                name: (d.method === 'new' && d.category !== 'داخل اللستة') ? `${d.name} (${d.category})` : d.name,
                unit: d.unit,
                unitSold: d.sold,
                category: d.category || 'N/A',
                timestamp: new Date().toISOString()
            }));

            db.ref('pharmacyData').push(payload)
                .then(() => {
                    showToast("Submitted Successfully");
                    addedData = [];
                    saveData();
                    renderTable();
                })
                .catch(e => {
                    console.error(e);
                    showToast("Error submitting", true);
                });
        }

        function showToast(msg, isErr) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = isErr ? 'error show' : 'show';
            setTimeout(() => t.className = '', 3000);
        }
    </script>
</body>
</html>
